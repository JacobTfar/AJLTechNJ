---
import Layout from '~/layouts/PageLayout.astro';
import HeroText from '~/components/widgets/HeroText.astro';
import ContactUs from '~/components/widgets/Contact.astro';
import Features2 from '~/components/widgets/Features2.astro';

const metadata = {
  title: 'Contact',
};
---

<Layout metadata={metadata}>
  <!-- HeroText Widget ******************* -->

  <HeroText tagline="Contact" title="Let's Connect!" />

  <ContactUs
    title="Drop us a message today!"
    subtitle="Email is the fastest way to reach us! For quicker answers, explore our FAQs section. You may find the solution you're looking for right there! If not, our support team is delighted to help you."
    inputs={[
      {
        type: 'text',
        name: 'from_name',
        label: 'Name',
      },
      {
        type: 'email',
        name: 'from_email',
        label: 'Email',
      },
    ]}
    textarea={{
      label: 'Message',
      name: 'message',
    }}
    disclaimer={{
      label:
        'By submitting this contact form, you acknowledge and agree to the collection of your personal information.',
    }}
    description="Our support team typically responds within 24 business hours."
  />

  <!-- Features2 Widget ************** -->

  <Features2
    title="We are here to help!"
    items={[
      {
        title: 'General Inquiries',
        description: `Contact us for questions about our services, pricing, scheduling appointments, or general information about AJL Tech NJ.`,
        icon: 'tabler:help-circle',
      },
      {
        title: 'Technical Support',
        description:
          'Get help with ongoing tech issues, subscription support, troubleshooting assistance, or questions about completed services.',
        icon: 'tabler:settings',
      },
      {
        title: 'Business Services',
        description:
          'Reach out for custom network installations, enterprise solutions, security system setup, or specialized business technology needs.',
        icon: 'tabler:building',
      },
      {
        title: 'Phone (Coming Soon)',
        description: 'Dedicated business line in setup - Please use email for now',
        icon: 'tabler:headset',
      },
      {
        title: 'General Email',
        description: 'info@ajltechnj.com',
        icon: 'tabler:mail',
      },
      {
        title: 'Technical Support',
        description: 'support@ajltechnj.com',
        icon: 'tabler:tool',
      },
    ]}
  />
</Layout>

<!-- EmailJS Integration -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js" is:inline
></script>
<script type="text/javascript" is:inline>
  // Initialize EmailJS with your correct public key
  emailjs.init('iFk6dR2JaXJllcyJj');

  let formHandlerAttached = false;

  function setupFormHandler() {
    if (formHandlerAttached) {
      console.log('Form handler already attached, skipping...');
      return;
    }

    console.log('Setting up form handler...');
    const forms = document.querySelectorAll('form');
    console.log('Found forms:', forms.length);

    if (forms.length > 0) {
      const form = forms[0];
      console.log('Selected form:', form);

      // Add ID if missing
      if (!form.id) {
        form.id = 'contact-form';
        console.log('Added ID to form');
      }

      // Handle form submission
      form.addEventListener('submit', function (event) {
        console.log('Form submission intercepted by EmailJS!');
        event.preventDefault();
        event.stopPropagation();
        handleFormSubmission(form);
        return false;
      });

      // Handle button clicks directly
      const submitButton = form.querySelector('button[type="submit"]');
      if (submitButton) {
        console.log('Found submit button, adding click handler');
        submitButton.addEventListener('click', function (event) {
          console.log('Submit button clicked!');
          event.preventDefault();
          event.stopPropagation();
          handleFormSubmission(form);
          return false;
        });
      }

      formHandlerAttached = true;
      console.log('Form handler attached successfully');
    } else {
      console.error('No forms found on page!');
    }
  }

  function handleFormSubmission(form) {
    console.log('Processing form submission...');

    // Get form data
    const formData = new FormData(form);
    console.log('Form data:');
    for (const [key, value] of formData.entries()) {
      console.log(`${key}: ${value}`);
    }

    // Update button state
    const submitButton = form.querySelector('button[type="submit"]');
    const originalText = submitButton ? submitButton.textContent : 'Contact us';

    if (submitButton) {
      submitButton.textContent = 'Sending...';
      submitButton.disabled = true;
    }

    // Send email via EmailJS
    emailjs
      .sendForm('service_rqrfp3j', 'template_nobdnyg', form)
      .then(function (response) {
        console.log('EmailJS SUCCESS:', response);
        alert("Message sent successfully! We'll get back to you within 24 hours.");
        form.reset();
      })
      .catch(function (error) {
        console.error('EmailJS ERROR:', error);
        alert('Failed to send message. Please try again or email us directly at info@ajltechnj.com');
      })
      .finally(function () {
        if (submitButton) {
          submitButton.textContent = originalText;
          submitButton.disabled = false;
        }
      });
  }

  // Multiple attempts to catch the form
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupFormHandler);
  } else {
    setupFormHandler();
  }

  window.addEventListener('load', setupFormHandler);

  // Also try after small delays
  setTimeout(setupFormHandler, 100);
  setTimeout(setupFormHandler, 500);
  setTimeout(setupFormHandler, 1000);
</script>
