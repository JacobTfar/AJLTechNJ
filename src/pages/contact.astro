---
import Layout from '~/layouts/PageLayout.astro';
import HeroText from '~/components/widgets/HeroText.astro';
import ContactUs from '~/components/widgets/Contact.astro';
import Features2 from '~/components/widgets/Features2.astro';

const metadata = {
  title: 'Contact',
};
---

<Layout metadata={metadata}>
  <!-- HeroText Widget ******************* -->

  <HeroText tagline="Contact" title="Let's Connect!" />

  <ContactUs
    title="Drop us a message today!"
    subtitle="Email is the fastest way to reach us! For quicker answers, explore our FAQs section. You may find the solution you're looking for right there! If not, our support team is delighted to help you."
    inputs={[
      {
        type: 'text',
        name: 'from_name',
        label: 'Name',
      },
      {
        type: 'email',
        name: 'from_email',
        label: 'Email',
      },
    ]}
    textarea={{
      label: 'Message',
      name: 'message',
    }}
    disclaimer={{
      label:
        'By submitting this contact form, you acknowledge and agree to the collection of your personal information.',
    }}
    description="Our support team typically responds within 24 business hours."
  />

  <!-- Features2 Widget ************** -->

  <Features2
    title="We are here to help!"
    items={[
      {
        title: 'General Inquiries',
        description: `Contact us for questions about our services, pricing, scheduling appointments, or general information about AJL Tech NJ.`,
        icon: 'tabler:help-circle',
      },
      {
        title: 'Technical Support',
        description:
          'Get help with ongoing tech issues, subscription support, troubleshooting assistance, or questions about completed services.',
        icon: 'tabler:settings',
      },
      {
        title: 'Business Services',
        description:
          'Reach out for custom network installations, enterprise solutions, security system setup, or specialized business technology needs.',
        icon: 'tabler:building',
      },
      {
        title: 'Phone (Coming Soon)',
        description: 'Dedicated business line in setup - Please use email for now',
        icon: 'tabler:headset',
      },
      {
        title: 'General Email',
        description: 'info@ajltechnj.com',
        icon: 'tabler:mail',
      },
      {
        title: 'Technical Support',
        description: 'support@ajltechnj.com',
        icon: 'tabler:tool',
      },
    ]}
  />
</Layout>

<!-- EmailJS Integration -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js" is:inline></script>
<script type="text/javascript" is:inline>
  // Initialize EmailJS with your public key
  emailjs.init('Ck9gkjhX0wmiVatpv');

  // More robust form handler - looks for any form on the page
  function setupFormHandler() {
    console.log('Setting up form handler...');
    const forms = document.querySelectorAll('form');
    console.log('Found forms:', forms.length);
    
    if (forms.length > 0) {
      const form = forms[0]; // Get the first (and likely only) form
      console.log('Selected form:', form);
      
      // Add ID if missing
      if (!form.id) {
        form.id = 'contact-form';
        console.log('Added ID to form');
      }
      
      form.addEventListener('submit', function (event) {
        console.log('Form submission intercepted!');
        event.preventDefault();
        
        // Get form data
        const formData = new FormData(form);
        console.log('Form data:');
        for (const [key, value] of formData.entries()) {
          console.log(`${key}: ${value}`);
        }
        
        // Update button state
        const submitButton = form.querySelector('button[type="submit"]') || form.querySelector('input[type="submit"]');
        if (submitButton) {
          submitButton.textContent = 'Sending...';
          submitButton.disabled = true;
        }
        
        // Send email via EmailJS
        emailjs.sendForm('service_rqrfp3j', 'template_nobdnyg', form)
          .then(function (response) {
            console.log('EmailJS SUCCESS:', response);
            alert("Message sent successfully! We'll get back to you within 24 hours.");
            form.reset();
          })
          .catch(function (error) {
            console.error('EmailJS ERROR:', error);
            alert('Failed to send message. Please try again or email us directly at info@ajltechnj.com');
          })
          .finally(function () {
            if (submitButton) {
              submitButton.textContent = 'Contact us';
              submitButton.disabled = false;
            }
          });
      });
      
      console.log('Form handler attached successfully');
    } else {
      console.error('No forms found on page!');
    }
  }

  // Try immediately when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupFormHandler);
  } else {
    setupFormHandler();
  }

  // Backup: try again after window loads
  window.addEventListener('load', function() {
    console.log('Window loaded, double-checking form handler...');
    const forms = document.querySelectorAll('form');
    if (forms.length > 0 && !forms[0].hasAttribute('data-handler-attached')) {
      forms[0].setAttribute('data-handler-attached', 'true');
      setupFormHandler();
    }
  });
</script>
