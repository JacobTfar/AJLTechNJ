---
import Layout from '~/layouts/PageLayout.astro';
import HeroText from '~/components/widgets/HeroText.astro';
import ContactUs from '~/components/widgets/Contact.astro';
import Features2 from '~/components/widgets/Features2.astro';

const metadata = {
  title: 'Contact',
};
---

<Layout metadata={metadata}>
  <!-- HeroText Widget ******************* -->

  <HeroText tagline="Contact" title="Let's Connect!" />

  <ContactUs
    title="Drop us a message today!"
    subtitle="Email is the fastest way to reach us! For quicker answers, explore our FAQs section. You may find the solution you're looking for right there! If not, our support team is delighted to help you."
    inputs={[
      {
        type: 'text',
        name: 'from_name',
        label: 'Name',
      },
      {
        type: 'email',
        name: 'from_email',
        label: 'Email',
      },
    ]}
    textarea={{
      label: 'Message',
      name: 'message',
    }}
    disclaimer={{
      label:
        'By submitting this contact form, you acknowledge and agree to the collection of your personal information.',
    }}
    description="Our support team typically responds within 24 business hours."
  />

  <!-- Features2 Widget ************** -->

  <Features2
    title="We are here to help!"
    items={[
      {
        title: 'General Inquiries',
        description: `Contact us for questions about our services, pricing, scheduling appointments, or general information about AJL Tech NJ.`,
        icon: 'tabler:help-circle',
      },
      {
        title: 'Technical Support',
        description:
          'Get help with ongoing tech issues, subscription support, troubleshooting assistance, or questions about completed services.',
        icon: 'tabler:settings',
      },
      {
        title: 'Business Services',
        description:
          'Reach out for custom network installations, enterprise solutions, security system setup, or specialized business technology needs.',
        icon: 'tabler:building',
      },
      {
        title: 'Phone (Coming Soon)',
        description: 'Dedicated business line in setup - Please use email for now',
        icon: 'tabler:headset',
      },
      {
        title: 'General Email',
        description: 'info@ajltechnj.com',
        icon: 'tabler:mail',
      },
      {
        title: 'Technical Support',
        description: 'support@ajltechnj.com',
        icon: 'tabler:tool',
      },
    ]}
  />
</Layout>

<!-- EmailJS Integration -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js" is:inline
></script>
<script type="text/javascript" is:inline>
  console.log('EmailJS script loading...');

  // Initialize EmailJS immediately
  emailjs.init('iFk6dR2JaXJllcyJj');
  console.log('EmailJS initialized with public key');

  function interceptForm() {
    console.log('Looking for forms...');
    const forms = document.querySelectorAll('form');
    console.log('Found forms:', forms.length);

    if (forms.length > 0) {
      const form = forms[0];
      console.log('Working with form:', form);

      // Remove any existing handlers
      const newForm = form.cloneNode(true);
      form.parentNode.replaceChild(newForm, form);

      // Prevent default form submission completely
      newForm.onsubmit = function (e) {
        console.log('Form onsubmit triggered - preventing default');
        e.preventDefault();
        e.stopPropagation();
        sendEmail(newForm);
        return false;
      };

      // Also handle button clicks
      const buttons = newForm.querySelectorAll('button');
      console.log('Found buttons:', buttons.length);

      buttons.forEach((button) => {
        console.log('Adding click handler to button:', button);
        button.onclick = function (e) {
          console.log('Button clicked - preventing default and sending email');
          e.preventDefault();
          e.stopPropagation();
          sendEmail(newForm);
          return false;
        };
      });

      console.log('Form intercepted successfully');
    } else {
      console.error('No forms found!');
    }
  }

  function sendEmail(form) {
    console.log('sendEmail function called');

    // Show form data
    const formData = new FormData(form);
    console.log('Form data:');
    for (const [key, value] of formData.entries()) {
      console.log(`${key}: ${value}`);
    }

    // Update button
    const button = form.querySelector('button');
    const originalText = button ? button.textContent : 'Contact us';

    if (button) {
      button.textContent = 'Sending...';
      button.disabled = true;
    }

    console.log('Sending via EmailJS...');

    // Send with EmailJS
    emailjs
      .sendForm('service_rqrfp3j', 'template_nobdnyg', form)
      .then(function (response) {
        console.log('SUCCESS!', response);
        alert("Message sent successfully! We'll get back to you within 24 hours.");
        form.reset();
      })
      .catch(function (error) {
        console.error('ERROR!', error);
        alert('Failed to send message. Please try again or email us directly at info@ajltechnj.com');
      })
      .finally(function () {
        if (button) {
          button.textContent = originalText;
          button.disabled = false;
        }
      });
  }

  // Try multiple times to catch the form
  console.log('Setting up form interception...');

  // Try immediately
  interceptForm();

  // Try when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', interceptForm);
  }

  // Try when window loads
  window.addEventListener('load', interceptForm);

  // Try with delays
  setTimeout(interceptForm, 100);
  setTimeout(interceptForm, 500);
  setTimeout(interceptForm, 1000);
  setTimeout(interceptForm, 2000);

  console.log('EmailJS script setup complete');
</script>
